# lct-hack

Сервис по прогнозированию и планированию закупок на основе машинного обучения с применением чат бота на основе большой языковой модели и веб-интерфейса для визуализации/редактирования прогнозов.

## Структура проекта
```
lct-hack
|
├── 2. ГПУ                                  # сырые данные
|
├── modeling                                # модуль с прогнозированием закупок
│   ├── ...
├── tg_bot                                  # модуль с умным ассистентом (GigaChat) на основе тг бота
│   ├── ...
├── web                                     # веб-интерфейс для детального анализа и редактировния прогнозов     
│   ├── ...
├── .env                                    # переменные окружения (токен тг бота и токен GigaChat)   
├── create_kernel.sh                        # установка Python и необходимых зависимостей 
├── main.py                                 # точка входа в ТГ бот
├── prepare_kernel.sh                       # первичная настройка окружения
├── README.md                               # описание проекта   
├── requirements.txt                        # список зависимостей  
├── run_web.py                              # запуск web-интерфейса
```
**более подробное описание каждого модуля в соответсвующих разделах*

## Инструкция по запуску

### Первичная настройка

1. Установить  [Conda](https://docs.conda.io/projects/conda/en/latest/index.html)
2. Установить pip `python -m ensurepip --upgrade`

### Копирование репозитория
```
git clone https://github.com/practical-knuth/lct-hack.git
```
### Подготовка окружения
*Перед запуском скрипта по подготовке окружения, в папку `2. ГПУ/` нужно положить файлы, предоставленные на хакатон*
```
cd lct-hack && bash prepare_kernel.sh && conda activate lct_env
```
### Заполнение переменных окружения 
Заполнение переменных
```
cp ./.env.sample ./.env && nano ./.env
```
Экспорт переменных в окружение
```
export $(xargs <.env)
```
### Запуск Телеграм Бота
```
python main.py
```

## Описание модулей

### tg_bot

Умный ассистент прогнозирования и планирования закупок на основе большой языковой модели ([GigaChat](https://developers.sber.ru/portal/products/gigachat))

#### Структура модуля

```
├── tg_bot
│   ├── chats
│   │   └── chat_id
│   ├── src
│   │   └── gigachat_agent.py
│   │   └── gigachat_tools.py
│   │   └── tg_bot.py
│   │   └── tg_commands_functions.py
│   ├── constants.py
```

- Директория `tg_bot` содержит все файлы, связанные с телеграмм ботом.
- Директория `chats` содержит папки чатов пользвоателей, в которых хранятся json прогнозов и рекомендаций по закупкам.
- Директория `src` содержит файлы команд телеграмм бота:
- `gigachat_agent.py` содержит скрипт инициализации gigachat-агента с прописанным промптом.
- `gigachat_agent.py` содержит функции-интрументы, которыми оперирует gigachat-агент, чтобы отвечать на вопросы пользователя, заданные на естественном языке.
- `tg_bot.py` содержит скрипт иницииализации телеграмм бота с типизированными командами и gigachat-агентом.
- `tg_commands_functions.py` содержит типизированные функции которые пользователь может вызввать из чата без использования естественного языка.

- `constants.py` содержит константы (имена колонок, пути к файлам).

#### Функционал

Доступные запросы на естественном языке:
1. Вывод списка товаров
2. Просмотр остатков по товару
3. Построение прогноза по товару на N месяцев вперед
4. Выгрузка прогнозов по всем товарам в формат JSON
5. Выгрузка рекомендаций по закупкам на основе прогноза и остатков в формат JSON

Ассистент может делать ошибки.
Он только учится, поэтому иногда может не понимать что нужно сделать, если он отвечает неправильно,
попробуйте перефразировать вопрос или воспользуйтесь *шаблонными командами*:
1. `/help` - Нажми для помощи.
2. `/get_product_name` - Увидеть названиия товаров.
3. `/get_product_stocks` - Посмотреть остатки на последнюю дату по определенному товару.
4. `/get_product_forecast` - Сделать прогноз по определенному товару.
5. `/download_all_forecasts` - Скачать прогнозы по всем товарам в формате json.
6. `/get_recommendation` - Получить рекомендации по закупкам.

*Со временем асистент будет развиваться и лучше понимать человеческую речь!*

#### Пример использования:
1. Чтобы узнать что умеет бот, спросите это у него в свободной форме или воспользуйтесь командой `/help`
2. Для получения информации о названиях товаров спросите это у бота, после чего вы получите список из N товаров, если бот не отправил вам товары, попробуйте перефразировать вопрос или воспользуйтесь шаблонной командой `/get_product_name`
3. Чтобы получить остатки по интересующему вас товару, спросите это у бота, передав ему точное названия товара, если бот не отправил вам остатки по товару, попробуйте перефразировать вопрос или воспользуйтесь шаблонной командой `/get_product_stocks`
4. Чтобы получить прогноз по интересующему вас товару, спросите это у бота, передав ему точное названия товара, если бот не отправил вам прогноз по товару, попробуйте перефразировать вопрос или воспользуйтесь шаблонной командой `/get_product_forecast`
5. Если вы хотите получить выгрузку прогнозов по всем товарам в формате json попросите бота об этом, если бот не отправил вам файл, попробуйте перефразировать вопрос или воспользуйтесь шаблонной командой `/download_all_forecasts`
6. Для получения рекомендаций по закупкам попросите это сделать бота, бот уведомит вас нужно ли вам сделать закупки и если нужно, то отправит вам json файл, если нет, то ответит, что закупок производить не нужно. Если бот не ответит вам, попробуйте перефразировать вопрос или воспользуйтесь шаблонной командой `/get_recommendation`

#### Библиотеки

- GigaChain: это библиотека Python, которая позволяет упростить и автоматизировать работу с нейросетевой моделью GigaChat и другими большими языковыми моделями (LLM). GigaChain является версией библиотеки LangChain, которая адаптирована для работы с русским языком.
- telebot (pyTelegramBotAPI): библиотека для создания телеграмм-бота на python для телеграмма.

### modeling
Реализация обучения и прогнозирования будущих запокупок с использованием градиентного бустинга.

- **Разрез**: наименование номенклатуры

- **Гранулярность**: М

- **Горизонт**: 12 

#### Структура модуля
```
├── modeling
│   ├── conf
│   │   └── constants.py
|   |   └── feature_engineering.py
|   |   └── modeling.py
|   |   └── paths.py
|   |   └── preprocessing.py
│   ├── src
│   │   └── feature_engineering.py
│   │   └── predicting.py
│   │   └── preprocess_data.py
│   │   └── preprocess_stocks.py
│   │   └── training.py
│   │   └── utils_training.py
│   ├── modeling.py
```
- Директория `conf` папка с конфигурациями прогнозирования
    - `conf/constants.py` - константы
    - `conf/feature_engineering.py` - параметры генерации признаков
    - `conf/modeling.py` - параметры обучения модели
    - `conf/paths.py` - пути к данным
    - `conf/preprocessing.py` - параметры предобработки данных
- Директория `src` исходный код полного пайплайна обучения и прогноза:
    - `src/feature_engineering.py` - генерация признаков
    - `src/predicting.py` - прогнозирование будущего периода
    - `src/preprocess_data.py` - вспомогательные функции предобработки данных
    - `src/preprocess_stocks.py` - предобработка данных и подготовка таргета
    - `src/training.py` - обучение моделей с поиском оптимального числа необходимых признаков и их отбором
    - `src/utils_training.py` - вспомогательные функции для обучения
- `modeling.py` - скрипт построения пайплайна обучения и прогнозирования 

#### Процесс прогнозирования

1. Предобработка данных и подготовка таргета;
2. Генерация признаков:
    - трансформация циклических временных признаков
    - роллинг агрегации целевой переменной 
    - лаговые значения целевой переменной
    - признаки тренда
    - значения целевой переменной в окрестности прошлого года
    - праздники
3. Обучение модели с поиском оптимального числа необходимых признаков и их последующим отбором на основе значений Shapely на отложенной валидационной выборке;
4. Прогноз.

### web
Веб-дашборд для прогнозирования спроса, созданный с использованием Python, Dash и Flask. Дашборд позволяет пользователям загружать данные в формате JSON, визуализировать данные о продуктах и выполнять анализ прогнозирования спроса. Кроме того, проект включает в себя документацию API с помощью Swagger UI, которая доступна для удобного просмотра и тестирования доступных методов API.

#### Запуск веб-сервиса
```
python run_web.py
```

#### Структура модуля

```
├── web
│   ├── assets
│   │   └── bootstrap.min.css
│   ├── static
│   │   └── swagger.json
│   ├── html_script.py
│   ├── web.py
│   └── requirements.txt
```
- Директория `web` содержит все файлы, связанные с веб-дашбордом
- Директория `assets` содержит файл `bootstrap.min.css`, который используется для стилизации дашборда
- Директория `static` содержит файл `swagger.json`, который содержит спецификацию API в формате Swagger
- `html_script.py` содержит компоненты HTML и CSS, используемые в макете дашборда
- `web.py` - это основной скрипт Python, который настраивает приложение Dash и Flask, определяет обратные вызовы для интерактивности и интегрирует Swagger UI
- `requirements.txt` перечисляет зависимости Python, необходимые для запуска проекта

#### Документация API

Документация API доступна через Swagger UI по адресу: `http://localhost:8050/api/docs`
или в самом интерфейсе при запуске веб-приложения (ссылка в правом верхнем углу).

#### Использование

1. Загрузите файл JSON, содержащий данные о продуктах, с помощью компонента загрузки файлов в дашборде.
2. Выберите продукт из выпадающего меню для визуализации его данных.
3. Настройте горизонт прогнозирования с помощью выпадающего меню горизонта.
4. Дашборд отобразит визуализацию данных о продукте, включая факт, прогнозы и остатки.
5. Анализ оставшихся запасов продукта будет предоставлен на основе выбранного горизонта прогнозирования.
6. Вы можете скачать измененные данные JSON для выбранного продукта с помощью кнопки "Скачать JSON".
7. Вы также можете скачать файл рекомендаций JSON с помощью кнопки "Скачать рекомендации".

#### Библиотеки

- Dash: Python-фреймворк для создания веб-приложений
- Plotly: библиотека для создания интерактивных визуализаций
- Flask: веб-фреймворк, используемый Dash для обслуживания приложения

## Summary
1. Пользователь общается с ассистентом, запрашивает остатки и просит сделать прогноз на будущий период;
2. Пользователь получает от ассистента файл `prediction.json` и загружает его в web-service
3. Пользователь анализирует графики и вносит правки в прогнозы и выгружает финальный файл
4. Дополнительно: пользователь может вручную запустить переобучение модели в любой момент в web-интурфейсе

## Авторы
- (с) Елисеев Семен, tg: @simonyelisey
- Алиева Рената, tg: @renatalii
- Дергачев Василий, tg: @Vasiliy_Dergachev 
- Кочанов Дмитрий, tg: @extrik